FROM ubuntu:22.04

# build guacd
RUN apt update && apt-get install -y gcc curl wget sed g++ libcairo2-dev libjpeg-turbo8-dev libpng-dev libtool-bin libossp-uuid-dev libswscale-dev build-essential libvncserver-dev
RUN mkdir -p /opt/guacamole
WORKDIR /opt/guacamole
RUN wget https://downloads.apache.org/guacamole/1.5.3/source/guacamole-server-1.5.3.tar.gz -P /opt/guacamole
RUN tar xzf guacamole-server-1.5.3.tar.gz
WORKDIR /opt/guacamole/guacamole-server-1.5.3
RUN ./configure --with-init-dir=/etc/init.d
RUN sed -i 's/-Werror//g' src/common-ssh/Makefile
RUN sed -i 's/-Werror//g' src/guacenc/Makefile
RUN make && make install && ldconfig

# set up pwner user
ARG USERNAME=pwner

ENV DEBIAN_FRONTEND noninteractive

RUN apt update && apt install -y gdb python3 tmux sudo netcat
RUN useradd -ms /bin/bash $USERNAME
RUN echo 'pwner\npwner' | passwd pwner
RUN echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME
USER $USERNAME
RUN mkdir /home/$USERNAME/pwn
WORKDIR /home/$USERNAME/pwn

RUN echo 'alias tmux="tmux -2"' >> /home/$USERNAME/.bashrc
RUN bash -c "$(curl -fsSL https://gef.blah.cat/sh)"
ENV LC_CTYPE=C.UTF-8

COPY vnc-server.py vnc-server.py

ENTRYPOINT ["/bin/bash"]
