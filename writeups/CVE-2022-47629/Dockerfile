FROM ubuntu:20.04

ARG USERNAME=pwner
# ARG LIBKSBA_COMMIT=e11e176   # 1.6.1
ARG LIBKSBA_COMMIT=ff8c0e8 # 1.6.2

ENV RUNNING_IN_DOCKER true
ENV DEBIAN_FRONTEND noninteractive

ARG CFLAGS="-g -fno-stack-protector"
RUN mkdir /opt/libksba-bug
WORKDIR /opt/libksba-bug
RUN apt update && apt install -y gdb git build-essential autoconf automake bison libgpg-error-dev texinfo libksba-dev patchelf
RUN git clone https://dev.gnupg.org/source/libksba.git \
    && cd libksba && git checkout $LIBKSBA_COMMIT && ./autogen.sh  && ./configure && make; exit 0
RUN cp /opt/libksba-bug/libksba/src/.libs/libksba.so.8.* /usr/lib/x86_64-linux-gnu/libksba.so.8

RUN apt update && apt install -y gdb python3 curl tmux zsh git sudo wget bat neovim netcat ltrace strace build-essential
RUN useradd -ms /usr/bin/zsh $USERNAME
RUN echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME
USER $USERNAME
RUN mkdir /home/$USERNAME/pwn
WORKDIR /home/$USERNAME/pwn

RUN git clone https://github.com/powerline/fonts.git --depth=1
RUN sh fonts/install.sh
RUN rm -rf fonts
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v1.1.3/zsh-in-docker.sh)" -- \
    -t bira \
    -p git \
    -p history-substring-search \
    -p https://github.com/zsh-users/zsh-autosuggestions \
    -p https://github.com/zsh-users/zsh-completions
RUN bash -c "$(curl -fsSL https://gef.blah.cat/sh)"

ENTRYPOINT ["/usr/bin/zsh"]
